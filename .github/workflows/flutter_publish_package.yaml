# Orchestrates: Check Tag -> Build -> Tag -> Deploy
name: Flutter Package Release

# To call this workflow, request the following permissions :
# permissions:
#   contents: write
#   id-token: write


on:
  workflow_call:
    secrets:
      FIREBASE_OPTIONS_DART:
        required: true
      FIREBASE_SERVICE_ACCOUNT:
        required: true

jobs:
  check_tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Extract version
        id: extract_version
        run: |
          version=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r')
          echo "VERSION=$version" >> $GITHUB_ENV
      - name: Fail if Tag Exists
        run: |
          git fetch --tags
          if git rev-parse "v${{ env.VERSION }}" > /dev/null 2>&1; then
            echo "Tag v${VERSION} already exists. Failing." >&2
            exit 1
          fi
      - name: Check if version exists in CHANGELOG.md
        run: |
          VERSION=${{ env.VERSION }}
          if ! grep -q "##\s*$VERSION" CHANGELOG.md; then
            echo "âŒ CHANGELOG.md does not contain an entry for version $VERSION"
            echo "ðŸ‘‰ Please add a changelog entry like: '## $VERSION'"
            exit 1
          fi
          echo "âœ… Found changelog entry for [$VERSION]"


  tag:
    needs: check_tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version
        run: |
          version=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r')
          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

  # Publish to pub.dev
  # Source : https://github.com/dart-lang/setup-dart/blob/v1.7.0/.github/workflows/publish.yml
  publish:
    needs: tag
    name: 'Publish to pub.dev'
    permissions:
      id-token: write # Required for authentication using OIDC
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up the Dart SDK and provision the OIDC token used for publishing.
      # The `dart` command from this step will be shadowed by the one from the
      # Flutter SDK below. 
      - uses: dart-lang/setup-dart@0a8a0fc875eb934c15d08629302413c671d3f672

      # Download flutter SDK - needed for publishing Flutter packages. Can also
      # publish pure Dart packages.
      #
      # The dart binary from a Flutter SDK facilitates publishing both Flutter
      # and pure-dart packages.
      - uses: flutter-actions/setup-flutter@d030cb603380106494f72d65a7e52462f380781f

      - name: Install dependencies
        run: dart pub get

      - name: Publish - dry run
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        run: dart pub publish -f

  build:
    needs: tag
    uses: Womotaq/github_actions/.github/workflows/flutter_build.yaml@main
    with:
      working_directory: example
    secrets:
      FIREBASE_OPTIONS_DART: ${{ secrets.FIREBASE_OPTIONS_DART }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download web build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: example/build/web

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}"
          channelId: live
          projectId: womotaq-f
          entryPoint: example
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
